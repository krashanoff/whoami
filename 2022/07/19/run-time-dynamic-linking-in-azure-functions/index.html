<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Leonid Krashanoff" />
  <meta name="dcterms.date" content="2022-07-19" />
  <title>Run-time dynamic linking in Azure Functions</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: blue;
    }
    a:visited {
      color: blue;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    div.abstract {
      margin: 2em 2em 2em 2em;
      text-align: left;
      font-size: 85%;
    }
    div.abstract-title {
      font-weight: bold;
      text-align: center;
      padding: 0;
      margin-bottom: 0.5em;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

    body {
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    figure {
      padding: 1rem;
      border: 1px solid #0b0b0b;
      display: flex;
      flex-flow: column nowrap;
      align-items: center;
    }

    figcaption {
      margin-top: 1rem;
    }

    footer {
      font-size: 0.75rem;
    }

    .codeblock {
      overflow: auto;
      overflow-wrap: normal;
      border: 1px solid black;
      padding: 1rem;
    }

    .codeblock > code {
      overflow-wrap: unset !important;
      white-space: unset;
    }

    @media print {
      .print-display-none {
        display: none;
      }
    }
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->

  <link
    rel="icon"
    href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAACXBIWXMAAC4jAAAuIwF4pT92AAAADElEQVQImWOoX/UGAAPBAhajZVPkAAAAAElFTkSuQmCC"
    type="image/png"
  />
</head>
<body>

<a class="print-display-none" href="/">Back to home</a>

<header id="title-block-header">
<h1 class="title">Run-time dynamic linking in Azure Functions</h1>
<p class="author">Leonid Krashanoff</p>
<p class="date">
    Published:
    <date>19 July 2022</date>
</p>
<p class="date">Last Updated: <date>07 December 2022</date></p>

<div class="abstract">
<div class="abstract-title">Abstract</div>
<p>Linking C++ code to C# code is easily accomplished with a
<code>[DllImport]</code>. Deploying it on an Azure Function is another beast.
Through exhaustive trial-and-error, it can be determined the Azure Function VM
doesn&#x2019;t permit run-time dynamic linking, but <em>does</em> permit execution of
pre-compiled binaries. To work around this problem, engineers can incorporate
the shared C++ code as a separate executable that is shelled out to. There are
build issues introduced in this approach that are unaddressed in this article,
but may be addressed in a later entry.</p>
</div>

<div class="tags">
<p>
  Tagged:
    <a href="/tags/software">software</a>
    <a href="/tags/reverse_engineering">reverse_engineering</a>
  </p>
</div>

</header>
<nav id="TOC" role="doc-toc">
<h2 id="toc-title">Table of Contents</h2>
<ul>
<li><a href="#background" id="toc-background"><span
class="toc-section-number">1</span> Background</a></li>
<li><a href="#deploying-to-azure-debugging"
id="toc-deploying-to-azure-debugging"><span
class="toc-section-number">2</span> Deploying to Azure + Debugging</a></li>
<li><a href="#the-solution" id="toc-the-solution"><span
class="toc-section-number">3</span> The Solution</a></li>
<li><a href="#takeaways" id="toc-takeaways"><span
class="toc-section-number">4</span> Takeaways</a></li>
<li><a href="#other-reading" id="toc-other-reading"><span
class="toc-section-number">5</span> Other Reading</a></li>
<li><a href="#changelog" id="toc-changelog"><span
class="toc-section-number">6</span> Changelog</a></li>
</ul>
</nav>
<p>If you read over the Microsoft article <a
href="https://docs.microsoft.com/en-us/azure/azure-functions/bring-dependency-to-functions?pivots=programming-language-python"
rel="noopener noreferrer" referrerpolicy="no-referrer">&#x201C;Bring dependencies or
third party library to Azure Functions&#x201D;</a>, you might be led to believe that
you can bundle dynamic libraries like Opus or maybe even libav into an <a
href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview"
rel="noopener noreferrer" referrerpolicy="no-referrer">Azure Function app</a>
and load them at run-time.</p>
<p>I investigated this when attempting to integrate some C# code with a C++
library. There&#x2019;s no concrete example for including any shared code in a C#
function application in this documentation page (likely because all C# code is
a DLL at the end of the day anyway). In theory, it should be as easy as
including the library code and associated bindings in the uploaded bundle.</p>
<section id="background" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span>
Background</h1>
<p>Let&#x2019;s write a very simple shared library to bundle into a C#
application.</p>
<div class="sourceCode" id="cb1" class="codeblock"><pre
class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="bu">std::</span>string<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="st">&quot;C&quot;</span> <span class="op">{</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="dt">bool</span> test<span class="op">(</span><span class="at">const</span> <span class="dt">char</span> <span class="op">*</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    string a<span class="op">(</span>i<span class="op">);</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">.</span>size<span class="op">()</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> a<span class="op">.</span>back<span class="op">()</span> <span class="op">==</span> <span class="ch">&#39;a&#39;</span><span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Here, we have a simple C++ FFI library that could be compiled to a shared
object with <code>g++ -shared -o libtest.so test.cpp</code>. The typical way
of including this functionality in a C# program would be to use C#&#x2019;s <a
href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.dllimportattribute?view=net-6.0"
rel="noopener noreferrer"
referrerpolicy="no-referrer"><code>DllImport</code></a> attribute. Here&#x2019;s an
example class binding to the function.</p>
<div class="sourceCode" id="cb2" class="codeblock"><pre
class="sourceCode cs"><code class="sourceCode cs"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">Runtime</span><span class="op">.</span><span class="fu">InteropServices</span><span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> TestLib <span class="op">{</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">DllImport</span><span class="op">(</span><span class="st">&quot;libtest.so&quot;</span><span class="op">)]</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">unsafe</span> <span class="kw">static</span> <span class="dt">bool</span> <span class="fu">test</span><span class="op">(</span>IntPtr i<span class="op">);</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>In production, some additional considerations are warranted:</p>
<ul>
<li>Set the <code>EntryPoint</code> property of the <code>DllImport</code>
attribute.</li>
<li>We could be using a <code>string</code> instead of an <code>IntPtr</code>
since their representation is - in practical application - the same.</li>
<li>Wrap the <code>unsafe</code> functionality in a safe, C#-native function
call.</li>
</ul>
<p>To integrate this into a published package, we could copy the library to
the publish directory with an additional <code>ItemGroup</code> in the
<code>.csproj</code> file for our application or library:</p>
<div class="sourceCode" id="cb3" class="codeblock"><pre
class="sourceCode xml"><code class="sourceCode xml"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">ItemGroup</span>&gt;</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">None</span><span class="ot"> Update=</span><span class="st">&quot;libtest.so&quot;</span><span class="ot"> CopyToOutputDirectory=</span><span class="st">&quot;Always&quot;</span> /&gt;</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">ItemGroup</span>&gt;</span></code></pre></div>
<p>This is easily incorporated into a Azure class library function by adding a
reference in its <code>.csproj</code>. Running the resulting function app
locally with <code>func start</code> works without issue. I tested this on
both my WSL subsystem and my Windows native system.</p>
</section>
<section id="deploying-to-azure-debugging" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Deploying to
Azure + Debugging</h1>
<p>After deploying a function that utilizes our shared library, though, any
request against it will return a 501.</p>
<p>The Azure Function app runtime is a bit of a black box. There isn&#x2019;t much
documentation about what file system operations are permitted, what container
capabilities are missing or forbidden, or exactly how it launches your
code.</p>
<p>With some early function returns and a lot of patience, I confirmed that
the function runs fine until the library tries to load. With additional
response-based testing on a live runtime, I was able to determine that:</p>
<ul>
<li>The shared library still exists on the runtime&#x2019;s disk.</li>
<li>The library can have its permissions changed, even through calls to
<code>chmod</code>.</li>
<li>Any attempt to call code using it will immediately halt the function,
returning a 501. Any code running before the call works fine. That is, the
library is dynamically linked at run-time.</li>
</ul>
<p>Hang on&#x2026; The library can be <code>chmod</code>&#x2019;d&#x2026; How did I
<code>chmod</code> the library in my code? <strong>I shelled out.</strong></p>
<p>Following this train of thought, I tried spawning an instance of
<code>echo</code> in a function app on the Linux runtime and sending an HTTP
response with its output, and it operated as expected. So if shelling out
works, then the &#x201C;dependencies&#x201D; part of the documentation was right, but I
can&#x2019;t seem to get the &#x201C;library&#x201D; part to work! Was I led astray?</p>
<p>Maybe, but it&#x2019;s more likely that I made an incorrect inference. The
documentation never once mentioned anything about libraries save for the
introduction. The only examples given used a statically-linked
<code>ffmpeg</code>. They may have aluded to being able to include shared
libraries, but they never explicitly stated it. They <em>especially</em>
didn&#x2019;t state it in C# - there wasn&#x2019;t even an example.</p>
</section>
<section id="the-solution" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> The
Solution</h1>
<p>Instead of providing C# bindings to the C++ library, I made the library&#x2019;s
functionality accessible through a statically-linked CLI application. This was
then exposed to the main application using a C# wrapper around <a
href="https://docs.microsoft.com/en-us/dotnet/api/system.diagnostics.process?view=net-6.0"
rel="noopener noreferrer"
referrerpolicy="no-referrer"><code>System.Diagnostics.Process</code></a>.</p>
<p>Lo and behold, it worked without a hitch. The hard part was combining the
C++ and C# build systems into a coherent, one-line command. I may write about
this more at a later date, but I did so with PowerShell.</p>
</section>
<section id="takeaways" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span>
Takeaways</h1>
<p>The Azure Function app runtime cannot load non-C# shared libraries, but it
<em>can</em> shell out to statically-linked executables. This holds despite
Azure&#x2019;s documentation and local development tools suggesting otherwise. If you
absolutely need to integrate shared code to an Azure Function app, make a
simple CLI for the subset of functionality your app requires.</p>
<p>Load-time dynamic linking is likely disabled for security reasons. Maybe
it&#x2019;s on me for failing to research enough, but I couldn&#x2019;t find any other
documentation on how the Azure runtime handles shared libraries for the life
of me, and ended up sinking way too much time into debugging. Hopefully this
knowledge will help others.</p>
</section>
<section id="other-reading" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Other
Reading</h1>
<ul>
<li>https://mark-borg.github.io/blog/2017/interop/</li>
<li>https://docs.microsoft.com/en-us/cpp/dotnet/dotnet-programming-with-cpp-cli-visual-cpp</li>
</ul>
<hr />
</section>
<section id="changelog" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span>
Changelog</h1>
<ul>
<li>Update 13 November 2023: made introductory part to an abstract.</li>
</ul>
</section>

<footer>
  <p>
    Copyright &copy; 2024 Leonid Krashanoff
  </p>
  <p>
    Questions? Corrections? Comments? Write me an email.
  </p>
</footer>

</body>
</html>
