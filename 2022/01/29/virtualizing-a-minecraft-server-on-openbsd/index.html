<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Software and other things."><link rel="shortcut icon" href=https://krashanoff.com/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>Virtualizing a Minecraft Server on OpenBSD</title></head><body><header id=banner><h2><a href=https://krashanoff.com/>krashanoff</a></h2><nav><ul><li><a href=/ title=posts>posts</a></li><li><a href=/about/ title=about>about</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Virtualizing a Minecraft Server on OpenBSD</h1><div><time>January 29, 2022</time></div></header><p><em>&ldquo;Thinking quickly, Dave constructs a homemade megaphone using only some string, a squirrel,
and a megaphone."</em><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>Minecraft recently got its bump to version 1.18.1, and my girlfriend and I have been looking
for a way to play without running the server locally on my machine. I have an OpenBSD box (see
<a href=https://krashanoff.com/2021/09/24/exploring-openbsd/>my previous post</a>) that I have been using for my remote
needs, so I figured I could run the server on it fairly easily.</p><h2 id=the-hardware>The Hardware</h2><p>First, let&rsquo;s meet the lambo I plan to have running this:</p><pre><code># top

...
CPU0 states:  ...
CPU1 states:  ...
Memory: Real: 82M/1782M act/tot Free: 6024M Cache: 1084M Swap: 0K/2818M
...

# df -h
Filesystem     Size    Used   Avail Capacity  Mounted on
/dev/ab0x      986M    107M    830M    11%    /
...
/dev/ab0y      9.4G    936M    8.1G    10%    /home
</code></pre><p>Oh hell yes. Two cores. Like 8G of RAM. <em>Maybe</em> 8G of disk space. We&rsquo;re gonna make this
thing work like Atlas.</p><h2 id=the-software>The Software</h2><p>To get a Minecraft server running, all you need is the latest version of the JRE. For most
machines, this really isn&rsquo;t a problem. Java <em>does</em> run on 3 billion devices<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>, after
all. How bad could it be? Let&rsquo;s go ahead and check <a href=http://ports.su/devel/jdk>ports</a>:</p><p><img src=/img/mcbsd/jdkports.png alt="jdk 1.8 in openbsd ports"></p><p>3 billion, it would seem, does not include OpenBSD. Well, not the latest version of Java, at least.
OpenBSD doesn&rsquo;t really have much in the way of modern luxury when it comes to Java. This is
in line with their philosophy, I mean think about how many damn licenses are sitting on a JRE.</p><p>This said, I am not so headstrong as to port my own OpenJDK, not so eager to find a way to
use <a href=https://openports.se/devel/jdk/17>OpenPorts</a>, and not so foolish as to use some weird hacky
stuff for running a <code>jar</code>, so what&rsquo;s the solution here?</p><p><strong>Isn&rsquo;t it so obvious? Just virtualize a Linux box!</strong></p><h2 id=enter-vmm4>Enter: <code>vmm(4)</code></h2><p>I decided to virtualize a lightweight Linux distribution inside of my OpenBSD box to run the latest
server, then NAT Minecraft clients to it.</p><p>It&rsquo;s easier to virtualize hardware on OpenBSD than you might think. <a href=https://man.openbsd.org/vmm.4><code>vmm(4)</code></a>
provides capability in spades. All we need to do to enable it is add a line to our
<a href=https://man.openbsd.org/rc.conf><code>rc.conf.local(8)</code></a>.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=nb>echo</span> <span class=s2>&#34;vmd_flags=&#34;</span> &gt;&gt; /etc/rc.conf.local
</code></pre></div><p>Let&rsquo;s go ahead and create our working directory and its virtual disk with <a href=https://man.openbsd.org/vmctl.8><code>vmctl(8)</code></a>.</p><pre><code># useradd -m -s /sbin/nologin /home/minecraft
# cd /home/minecraft
# vmctl create -s 5G minecraft.qcow2
vmctl: qcow2 imagefile created
</code></pre><p>All we have to do now is just pick a Linux distribution to run on our (admittedly sparing) disk
space. All I really need is <a href=https://www.alpinelinux.org/>Alpine</a>, since it supports the latest
JDK and keeps things tidy. After fetching the boot disk, the startup command isn&rsquo;t so bad:</p><pre><code># vmctl start -m 2G -L -i 1 -r alpine-virt-x86_64.iso \
  -d minecraft.qcow2 minecraft
vmctl: started vm 1 successfully, tty /dev/ttyp1
</code></pre><ul><li><code>-m 2G</code>: 2G of memory.</li><li><code>-L</code>: link over network. Basically spin up a subnet for the VM.</li><li><code>-i 1</code>: one network interface.</li><li><code>-r</code>: boot from an image.</li></ul><p>All set.</p><pre><code># vmctl show
   ID   PID VCPUS  MAXMEM  CURMEM     TTY        OWNER    STATE NAME
    1 24772     1    2.0G   96.4M   ttyp1         root  running minecraft
</code></pre><p>I won&rsquo;t lie, a 5G disk might be a bit pessimistic for how small we can get this thing, and 2G of memory
might be pushing it for a machine that&rsquo;s rocking the base amount that you&rsquo;d expect out of a nicer
Chromebook<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>. We&rsquo;ll limit test later, though. Right now, there are more important matters to tend
to.</p><h2 id=nat>NAT</h2><p>Before we can use our machine to reach the internet, we&rsquo;ve got to redirect traffic to it.
Time for <a href=https://man.openbsd.org/pf><code>pf(4)</code></a> to go to work. We add a rule to redirect traffic in
on port 25565, and allow outbound traffic.</p><p>I don&rsquo;t run my server as a DNS cache, so the third rule (pulled from <a href=https://xosc.org/vmm.html>xhr&rsquo;s post</a>)
maps DNS to <a href=https://1.1.1.1/>Cloudflare</a>.</p><pre><code>match out on egress from $minecraft to any \
    nat-to egress
pass out on egress from $minecraft to any \
    nat-to egress
pass in proto udp from $minecraft to any port \
    domain rdr-to 1.1.1.1 port domain

pass in on egress proto tcp from any to (egress) \
    port { 25565 } rdr-to $minecraft
pass in on egress proto udp from any to (egress) \
    port { 25565 } rdr-to $minecraft
</code></pre><p>Before putting these rules into action, make sure that we have IP forwarding enabled in
<a href=https://man.openbsd.org/sysctl.conf.5><code>sysctl(5)</code></a>:</p><pre><code># sysctl net.inet.ip.forwarding
net.inet.ip.forwarding=1
</code></pre><p>Networking is ready for our VM. Let&rsquo;s get to work.</p><h2 id=setup-alpine><code>setup-alpine</code></h2><p>Time to get our virtual machine set up. We can hop into the VM&rsquo;s console, login as <code>root</code>, and
run <a href=https://wiki.alpinelinux.org/wiki/Installation><code>setup-alpine</code></a> as usual.</p><pre><code># vmctl console minecraft
Connected to /dev/ttyp1 (speed 115200)
</code></pre><p>Alpine&rsquo;s install is streamlined like OpenBSD&rsquo;s. Just page through with sane defaults and we&rsquo;re
set. Surprisingly, the arduous portion of this operation was just waiting for it to ping mirrors,
start chrony, all that good stuff.</p><p>After that&rsquo;s all set, we have to install dependencies. The only dependency we really need to run
our Minecraft server is <a href=https://pkgs.alpinelinux.org/package/edge/community/aarch64/openjdk17>openjdk17</a>.</p><p>Since this is available in community, we install it by specifying the repository:</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh>apk add openjdk17 --repository<span class=o>=</span>https://pkgs.alpinelinux.org/package/edge/community/aarch64/openjdk17
</code></pre></div><p>Once that&rsquo;s done, we can check our version of the JRE.</p><pre><code># java --version
openjdk 17.0.2 2022-01-18
OpenJDK Runtime Environment (build 17.0.2+8-alpine-r0)
OpenJDK 64-Bit Server VM (build 17.0.2+8-alpine-r0, mixed mode, sharing)
</code></pre><p>Looking good. After downloading the latest Minecraft server <code>jar</code> and prepping our server directory,
we just add the driver script for our preferred <code>java</code> command as a start script in <code>/etc/local.d/</code>.</p><h2 id=on-boot>On-Boot</h2><p>If we want to let this run automatically, we&rsquo;re going to have to set up our VM to start on boot. This
is accomplished through <a href=https://man.openbsd.org/vm.conf><code>vm.cfg(5)</code></a>.</p><pre><code>vm &quot;minecraft&quot; {
    memory 2G
    enable
    disk /home/minecraft/minecraft.qcow2
    local interface
    owner minecraft
}
</code></pre><p>Now when we reboot, the machine will run at boot and run under the <code>minecraft</code> user.</p><h2 id=limit-testing>Limit Testing</h2><p>Surprisingly, the entire Alpine + JDK install only comes out to about 345MiB. The size of the minecraft
server installation on my Windows disk is about 391MB. So what we <em>really</em> require in disk space is about
3G. If we really wanted to push it, we could go to about 2G.</p><p>The amount of RAM the VM sips at idle is about ~300MB, so we could shove its RAM consumption down to
about 1.5G.</p><pre><code>athome# vmctl show minecraft
   ID   PID VCPUS  MAXMEM  CURMEM     TTY        OWNER    STATE NAME
    1 28555     1    1.5G    1.5G   ttyp1         root  running minecraft
</code></pre><p>&mldr;okay maybe we can&rsquo;t. I went ahead and upped the memory to around 3G and that seemed to do the trick
for the stock server command that grants the <code>jar</code> about 1G of RAM.</p><h2 id=performance>Performance</h2><p>And so comes the question: is it fast? Well, not really.</p><p>I tested it out and saw a pretty <em>okay</em> TPS, but it&rsquo;s clear that a Minecraft server wasn&rsquo;t meant to be
run on a virtual machine with meager resources allocated to it on an already-resource-limited host.
Notably, the whole server would eat dirt when transitioning between the Overworld and the Nether.</p><p>Once chunks were loaded, performance wasn&rsquo;t an issue on the local network. Player activity was fairly
snappy. This said, the chunk load time being painful made me uncomfortable taking this Frankenstein
out of the lab. I just stuck with my own machine.</p><h2 id=conclusions-and-future-considerations>Conclusions and Future Considerations</h2><p>Running a Minecraft server on a virtualized Alpine machine isn&rsquo;t a bad idea if you have the hardware
for it. I do not.</p><p>In the future, I&rsquo;d like to upgrade my server hardware and try this again, experimenting with ways of
storing the Minecraft world folder in a host-system accessible folder. On any other virtualization
solution, this wouldn&rsquo;t be too hard, but OpenBSD&rsquo;s virtualization daemon doesn&rsquo;t support hardware
passthrough yet<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><p>Network passthrough is a breeze with <a href=https://man.openbsd.org/pf><code>pf(4)</code></a>, but the only viable option
for file-sharing between the two is through a network share like <a href=https://linux.die.net/man/8/smbd><code>smbd(8)</code></a>.
That would kill performance.</p><p>I think that if I were to get this set up, I&rsquo;d just have a cronjob on the VM that periodically backs
up the Minecraft world at regular intervals over SSH to an S3 bucket with <a href=https://rclone.org/><code>rclone(1)</code></a>.</p><div class=highlight><pre class=chroma><code class=language-sh data-lang=sh><span class=cp>#!/bin/sh
</span><span class=cp></span><span class=nv>NAME</span><span class=o>=</span><span class=s2>&#34;backup-</span><span class=k>$(</span>date +%D<span class=k>)</span><span class=s2>.tar.gz&#34;</span>
tar -czf <span class=nv>$NAME</span> /root/server
rclone copy <span class=nv>$NAME</span> s3:/minecraftWorlds/
</code></pre></div><p>Anyways, this was a fun little project and an educative experience. I may return to it to see if I
can improve performance on the little server that could™.</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href="https://www.youtube.com/watch?v=d59J78yhwtg">https://www.youtube.com/watch?v=d59J78yhwtg</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=https://skeptics.stackexchange.com/a/9873>https://skeptics.stackexchange.com/a/9873</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p>You&rsquo;d expect to see around 8GB in newer models. <a href=https://zipso.net/chromebook-specs-comparison-table/>https://zipso.net/chromebook-specs-comparison-table/</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></article></main><footer id=footer>Copyright © 2022 Leonid Krashanoff</footer></body></html>