<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Software and other things."><link rel="shortcut icon" href=https://krashanoff.com/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>An SSH Tarpit in 24 Lines</title></head><body><header id=banner><h2><a href=https://krashanoff.com/>krashanoff</a></h2><nav><ul><li><a href=/ title=posts>posts</a></li><li><a href=/about/ title=about>about</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>An SSH Tarpit in 24 Lines</h1><div><time>September 27, 2021</time></div></header><p>I found Chris Wellons' <a href=https://nullprogram.com/blog/2019/03/22/>endlessh</a>
to be very neat, so I wrote a short one in Rust. This compiles down to about
337kB after stripping metadata on the <code>current-thread</code> flavor of <a href=https://tokio.rs/><code>tokio</code></a>.</p><p>If you want to try it yourself, you can run it with <code>./binname [PORT NUMBER]</code>.</p><div class=highlight><pre class=chroma><code class=language-rs data-lang=rs><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=p>{</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>time</span>::<span class=n>Duration</span><span class=p>};</span><span class=w>
</span><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>tokio</span>::<span class=p>{</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>io</span>::<span class=n>AsyncWriteExt</span><span class=p>,</span><span class=w> </span><span class=n>net</span>::<span class=n>TcpListener</span><span class=p>,</span><span class=w> </span><span class=n>time</span>::<span class=n>interval</span><span class=p>};</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=cp>#[tokio::main]</span><span class=w>
</span><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>port</span>: <span class=nb>String</span> <span class=o>=</span><span class=w> </span><span class=n>env</span>::<span class=n>args</span><span class=p>().</span><span class=n>skip</span><span class=p>(</span><span class=mi>1</span><span class=p>).</span><span class=n>collect</span><span class=p>();</span><span class=w>
</span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>listener</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TcpListener</span>::<span class=n>bind</span><span class=p>(</span><span class=n>format</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;0.0.0.0:{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>))</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=k>await</span><span class=w>
</span><span class=w>        </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;failed to bind to port&#34;</span><span class=p>);</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Ok</span><span class=p>((</span><span class=k>mut</span><span class=w> </span><span class=n>stream</span><span class=p>,</span><span class=w> </span><span class=n>_</span><span class=p>))</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>listener</span><span class=p>.</span><span class=n>accept</span><span class=p>().</span><span class=k>await</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>            </span><span class=n>tokio</span>::<span class=n>spawn</span><span class=p>(</span><span class=k>async</span><span class=w> </span><span class=k>move</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>interval</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>interval</span><span class=p>(</span><span class=n>Duration</span>::<span class=n>from_secs</span><span class=p>(</span><span class=mi>5</span><span class=p>));</span><span class=w>
</span><span class=w>                </span><span class=k>loop</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stream</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=s>b&#34;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>).</span><span class=k>await</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>                        </span><span class=n>eprintln</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span><span class=w>                    </span><span class=p>}</span><span class=w>
</span><span class=w>                    </span><span class=n>interval</span><span class=p>.</span><span class=n>tick</span><span class=p>().</span><span class=k>await</span><span class=p>;</span><span class=w>
</span><span class=w>                </span><span class=p>}</span><span class=w>
</span><span class=w>            </span><span class=p>});</span><span class=w>
</span><span class=w>        </span><span class=p>}</span><span class=w>
</span><span class=w>    </span><span class=p>}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></div></article></main><footer id=footer>Copyright Â© 2021 Leonid Krashanoff</footer></body></html>